#!/bin/bash

set -x

main() {
    if [ ! -z $DISABLE_TESTS ]; then
        return
    fi

    TARGET="$1"

    set -e
    dir="$(dirname $0)"
    cross="$dir/cross-test"

    mkdir -p "$dir/../compile-test/tests/run-pass-failing/panic-runtime"
    mkdir -p "$dir/../compile-test/tests/run-pass-failing/union"
    args="$($dir/args $TARGET)"

    if [ -f "$dir/../docker/$TARGET/Dockerfile" ]; then
        docker build -t japaric/$TARGET -f "$dir/../docker/$TARGET/Dockerfile" "$dir/../docker"
    fi

    set +e

    ret=0
    crates="-p alloc -p core -p std -p std_unicode"
    if [ -z "$IGNORE" ]; then
        if ! cross test --lib \
                   $crates \
                   --target $TARGET \
                   --no-fail-fast \
                   -- $args; then
            ret=1
        fi
        if ! cross test --lib \
                   $crates \
                   --target $TARGET \
                   --release \
                   --no-fail-fast \
                   -- $args; then
            ret=1
        fi
    fi

    if [ -z "$IGNORE_COMPILE_TEST" ]; then
        if ! cross test \
                   --manifest-path compile-test/Cargo.toml \
                   --target $TARGET \
                   --no-fail-fast; then
            ret=1
        fi
    fi

    exit $ret
}

main "$@"
